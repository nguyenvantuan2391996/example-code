<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Image Decoder (Tailwind)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-6">
  <main class="w-full max-w-3xl bg-white rounded-2xl shadow-lg p-6">
    <h1 class="text-2xl font-semibold mb-4">QR Image → Data</h1>

    <p class="text-sm text-slate-600 mb-4">Chọn (hoặc kéo & thả) ảnh chứa mã QR. Ứng dụng sẽ hiển thị ảnh và dữ liệu giải mã được.</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <section>
        <label class="block mb-2 text-sm font-medium text-slate-700">Chọn ảnh QR</label>
        <div id="drop" class="border-2 border-dashed border-slate-200 rounded-lg p-6 text-center cursor-pointer hover:border-slate-300 transition">
          <input id="fileInput" type="file" accept="image/*" class="hidden" />
          <div class="mx-auto max-w-xs">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16V8a4 4 0 014-4h2m4 12V8a4 4 0 00-4-4h-1m-5 12h8" />
            </svg>
            <p class="mt-3 text-sm text-slate-500">Kéo & thả ảnh ở đây, hoặc <button id="chooseBtn" class="text-indigo-600 font-medium hover:underline">chọn file</button></p>
            <p id="dropHint" class="mt-2 text-xs text-slate-400">Hỗ trợ PNG, JPG, WebP...</p>
          </div>
        </div>

        <div class="mt-6">
          <h2 class="text-sm font-medium text-slate-700">Data (kết quả)</h2>
          <pre id="result" class="mt-2 p-3 bg-slate-50 rounded-md border border-slate-100 text-sm break-words min-h-[4rem]">Chưa có dữ liệu</pre>

          <div id="meta" class="mt-3 text-xs text-slate-500"></div>

          <div class="mt-4 flex gap-2">
            <button id="copyBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md text-sm disabled:opacity-50">Copy</button>
            <button id="clearBtn" class="px-4 py-2 border border-slate-200 rounded-md text-sm">Clear</button>
          </div>
        </div>
      </section>

      <section>
        <h2 class="text-sm font-medium text-slate-700">Preview ảnh</h2>
        <div class="mt-2 flex items-center justify-center rounded-md border border-slate-100 bg-slate-50 p-4 min-h-[220px]">
          <img id="preview" alt="QR preview" class="max-w-full max-h-[420px] object-contain rounded-md shadow-sm" />
        </div>

        <div class="mt-4 text-xs text-slate-500">Canvas nội bộ dùng để đọc mã (ẩn).</div>
      </section>
    </div>

    <canvas id="canvas" style="display:none"></canvas>

    <footer class="mt-6 text-xs text-slate-400">Built with Tailwind + jsQR</footer>
  </main>

<script>
const fileInput = document.getElementById('fileInput');
const chooseBtn = document.getElementById('chooseBtn');
const drop = document.getElementById('drop');
const preview = document.getElementById('preview');
const resultEl = document.getElementById('result');
const metaEl = document.getElementById('meta');
const canvas = document.getElementById('canvas');
const copyBtn = document.getElementById('copyBtn');
const clearBtn = document.getElementById('clearBtn');

chooseBtn.addEventListener('click', () => fileInput.click());

;['dragenter','dragover'].forEach(evt => {
  drop.addEventListener(evt, e => { e.preventDefault(); drop.classList.add('ring-2','ring-indigo-200'); });
});
;['dragleave','drop'].forEach(evt => {
  drop.addEventListener(evt, e => { e.preventDefault(); drop.classList.remove('ring-2','ring-indigo-200'); });
});

drop.addEventListener('drop', (e) => {
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if (f) handleFile(f);
});

fileInput.addEventListener('change', (e) => {
  const f = e.target.files && e.target.files[0];
  if (f) handleFile(f);
});

copyBtn.addEventListener('click', async () => {
  const text = resultEl.textContent || '';
  if (!text || text.trim() === 'Chưa có dữ liệu') return;
  try {
    await navigator.clipboard.writeText(text);
    copyBtn.textContent = 'Copied!';
    setTimeout(()=> copyBtn.textContent = 'Copy', 1200);
  } catch (err) {
    alert('Không thể copy: ' + err);
  }
});

clearBtn.addEventListener('click', () => {
  preview.src = '';
  resultEl.textContent = 'Chưa có dữ liệu';
  metaEl.textContent = '';
});

function handleFile(file) {
  if (!file.type.startsWith('image/')){
    alert('Vui lòng chọn file ảnh.');
    return;
  }
  const reader = new FileReader();
  reader.onload = () => {
    preview.src = reader.result;
    preview.onload = () => decodeImage(preview, file.name, file.size);
  };
  reader.readAsDataURL(file);
}

function decodeImage(imgEl, fname, fsize){
  const MAX = 1024;
  let w = imgEl.naturalWidth;
  let h = imgEl.naturalHeight;
  const scale = Math.min(1, MAX / Math.max(w,h));
  w = Math.round(w * scale);
  h = Math.round(h * scale);

  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,w,h);
  ctx.drawImage(imgEl, 0, 0, w, h);

  const imgData = ctx.getImageData(0,0,w,h);
  try {
    const code = jsQR(imgData.data, imgData.width, imgData.height, { inversionAttempts: 'attemptBoth' });
    if (code) {
      drawLocation(ctx, code.location);

      resultEl.textContent = code.data;
      metaEl.textContent = `Found. Size: ${imgData.width}×${imgData.height}. File: ${fname} (${formatBytes(fsize)})`;
    } else {
      resultEl.textContent = 'Không tìm thấy QR trong ảnh.';
      metaEl.textContent = `Scanned size: ${imgData.width}×${imgData.height}`;
    }
  } catch (err) {
    resultEl.textContent = 'Lỗi khi giải mã: ' + err;
  }
}

function drawLocation(ctx, loc){
  if (!loc) return;
  ctx.strokeStyle = 'red';
  ctx.lineWidth = Math.max(2, Math.min(6, Math.max(canvas.width, canvas.height) / 300));
  ctx.beginPath();
  ctx.moveTo(loc.topLeftCorner.x, loc.topLeftCorner.y);
  ctx.lineTo(loc.topRightCorner.x, loc.topRightCorner.y);
  ctx.lineTo(loc.bottomRightCorner.x, loc.bottomRightCorner.y);
  ctx.lineTo(loc.bottomLeftCorner.x, loc.bottomLeftCorner.y);
  ctx.closePath();
  ctx.stroke();

  preview.src = canvas.toDataURL('image/png');
}

function formatBytes(bytes){
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B','KB','MB','GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
</script>
</body>
</html>
